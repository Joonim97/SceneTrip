{% extends 'base.html' %}

{% block title %}
  {% if community %}
    커뮤니티 글 수정
  {% else %}
    커뮤니티 글 작성
  {% endif %}
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>
    {% if community %}
      커뮤니티 글 수정
    {% else %}
      커뮤니티 글 작성
    {% endif %}
  </h2>
  <form id="community-form" enctype="multipart/form-data" method="POST">
    <div class="mb-3">
      <label for="title" class="form-label">제목</label>
      <input type="text" class="form-control" id="title" name="title" value="{{ community.title|default_if_none:'' }}" required>
    </div>
    <div class="mb-3">
      <label for="content" class="form-label">내용</label>
      <textarea class="form-control" id="content" name="content" rows="6" required>{{ community.content|default_if_none:'' }}</textarea>
    </div>
    <div class="mb-3">
      <label for="community_images" class="form-label">이미지 업로드</label>
      <input type="file" class="form-control" id="community_images" name="community_images" multiple>
    </div>
    <button type="submit" class="btn btn-primary" style="background-color:#546E7A; border: none;">
      {% if community %}
        글 수정
      {% else %}
        글 작성
      {% endif %}
    </button>
  </form>

  <script>
    document.addEventListener

    function submitCommunity() {
      const accessToken = localStorage.getItem('access_token');
      
      if (!accessToken) {
        alert("로그인 후 이용해주세요.");
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
      }
    
      const formData = new FormData();
      formData.append('title', document.getElementById('title').value);
      formData.append('content', document.getElementById('content').value);
    
      const imageFiles = document.getElementById('community_images').files;
      for (let i = 0; i < imageFiles.length; i++) {
        formData.append('community_images', imageFiles[i]);
      }
    
      let url = "/api/communities/write/";
      let method = "POST";

      {% if community %}
        url = `/api/communities/{{ community.communityKey }}/edit/`;
        method = "PUT";
      {% endif %}
    
      fetch(url, {
        method: method,
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`커뮤니티 처리 실패: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        alert('커뮤니티 글이 성공적으로 처리되었습니다.');
        window.location.href = `/api/communities/${data.communityKey}/`;
      })
      .catch(error => {
        console.error('에러 발생:', error);
        alert(`커뮤니티 글 처리 중 문제가 발생했습니다: ${error.message}`);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('community-form').onsubmit = function(event) {
        event.preventDefault();
        submitCommunity();
      };
    });
  </script>
  
</div>
{% endblock %}
