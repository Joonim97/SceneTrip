{% extends 'base.html' %}

{% block title %}
커뮤니티 글 상세
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>{{ community.title }}</h2>
  <p>작성자: {{ community.author }} | 작성일: <span id="created-at"></span>
    <button id="edit-btn" class="btn btn-warning" style="display: none;">수정</button>
    <button id="delete-btn" class="btn btn-danger" style="display: none;">삭제</button>
  </p>
  
  <div class="mt-4">
    <p>{{ community.content }}</p>
  </div>
  
  <!-- 이미지 목록 -->
  <div class="mt-4">
    <div class="row">
      {% for image in community.community_images %}
      <div class="col-md-4 mb-3">
        <img src="{{ image.community_image }}" class="img-fluid" alt="community image">
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- 좋아요 / 싫어요 버튼 -->
  <div class="mt-4">
    <button id="like-btn" class="btn btn-outline-success">좋아요</button>
    <button id="dislike-btn" class="btn btn-outline-danger">싫어요</button>
    <span>좋아요 수: {{ community.community_likes.count }} | 싫어요 수: {{ community.community_dislikes.count }}</span>
  </div>

  <div class="mt-5">
    <h5>댓글</h5>
    <div id="comments-section">
      {% for comment in community.comments %}
      <div class="comment mb-4">
        <p><strong>{{ comment.user_nickname }} :</strong> {{ comment.content }}</p>
        <p><small id="created-at-{{ comment.id }}" data-created-at="{{ comment.created_at }}"></small></p>
        <!-- 댓글 좋아요/싫어요 버튼 -->
        <button class="btn btn-sm btn-outline-success like-comment-btn" data-comment-id="{{ comment.id }}">👍<span>{{ comment.like_count }}</span></button>
        
        <button class="btn btn-sm btn-outline-danger dislike-comment-btn" data-comment-id="{{ comment.id }}">👎<span>{{ comment.dislike_count }}</span></button>
        
      </div>
      {% endfor %}
    </div>
  
    <!-- 댓글 작성 폼 -->
    <div class="mt-4">
      <h5>댓글 작성</h5>
      <form id="comment-form" method="POST">
        <div class="form-group">
          <textarea id="comment-content" class="form-control" rows="3" placeholder="댓글을 입력하세요"></textarea>
        </div>
        <button type="submit" class="btn btn-primary mt-3">댓글 작성</button>
      </form>
    </div>
  </div>
<script>

  document.addEventListener('DOMContentLoaded', function () {
    const accessToken = localStorage.getItem('access_token');

    if (accessToken) {
      fetch("/api/accounts/user-info/", {
        method: "GET",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        // 로그인한 사용자의 닉네임과 작성자의 닉네임이 일치하는지 확인
        if (data.nickname === "{{ community.author }}") {
          // 작성자가 일치하면 수정, 삭제 버튼을 표시
          document.getElementById('edit-btn').style.display = 'inline-block';
          document.getElementById('delete-btn').style.display = 'inline-block';
        }
      })
      .catch(error => {
        console.error('에러 발생:', error);
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
      });
    }
});

  // 좋아요 버튼 동작
  document.getElementById('like-btn').addEventListener('click', function() {
    // 좋아요 처리 로직 추가
    alert("좋아요 클릭됨");
  });

  // 싫어요 버튼 동작
  document.getElementById('dislike-btn').addEventListener('click', function() {
    // 싫어요 처리 로직 추가
    alert("싫어요 클릭됨");
  });

  // 댓글 작성 처리
  document.getElementById('comment-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const commentContent = document.getElementById('comment-content').value;
    const communityId = "{{ community.id }}";
    const accessToken = localStorage.getItem('access_token');
    
    fetch(`/api/communities/${communityId}/comments/`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content: commentContent })
    })
    .then(response => response.json())
    .then(data => {
      alert('댓글이 작성되었습니다.');
      location.reload(); // 댓글 작성 후 페이지 새로고침
    })
    .catch(error => {
      console.error('댓글 작성 중 에러 발생:', error);
      alert('댓글 작성에 실패했습니다.');
    });
  });

  // 댓글 좋아요/싫어요 버튼 처리
  document.querySelectorAll('.like-comment-btn').forEach(button => {
    button.addEventListener('click', function() {
      const commentId = button.getAttribute('data-comment-id');
      fetch(`/api/communities/comments/${commentId}/like/`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
        },
      })
      .then(response => response.json())
      .then(data => {
        alert('좋아요 처리 완료');
        location.reload(); // 좋아요 처리 후 새로고침
      });
    });
  });

  document.querySelectorAll('.dislike-comment-btn').forEach(button => {
    button.addEventListener('click', function() {
      const commentId = button.getAttribute('data-comment-id');
      fetch(`/api/communities/comments/${commentId}/dislike/`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
        },
      })
      .then(response => response.json())
      .then(data => {
        alert('싫어요 처리 완료');
        location.reload(); // 싫어요 처리 후 새로고침
      });
    });
  });

  document.getElementById('delete-btn').addEventListener('click', function() {
    if (confirm('정말로 이 글을 삭제하시겠습니까?')) {
        const accessToken = localStorage.getItem('access_token');
        fetch(`/api/communities/{{ community.id }}/`, {
            method: "DELETE",
            headers: {
                'Authorization': `Bearer ${accessToken}`,
            }
        })
        .then(response => {
            if (response.ok) {
                alert('삭제되었습니다.');
                window.location.href = "{% url 'communities:community_list' %}";
            } else {
                alert('삭제 중 문제가 발생했습니다.');
            }
        });
    }
});

document.getElementById('edit-btn').addEventListener('click', function() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
        alert('로그인 후 이용해주세요.');
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
    }

    // Redirect to edit page
    window.location.href = `/api/communities/{{ community.id }}/edit/`;
});

  // 댓글의 created_at을 처리하는 함수
  function formatDate(dateString) {
    const date = new Date(dateString);
    const year = String(date.getFullYear()).slice(2);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}.${month}.${day} ${hours}:${minutes}`;
  }

  // 모든 댓글의 날짜를 처리하는 부분
  document.querySelectorAll('[id^="created-at-"]').forEach(function(element) {
    const createdAt = element.getAttribute('data-created-at');
    element.textContent = formatDate(createdAt);
  });

  const createdAt = "{{ community.created_at }}"; 

  // 변환된 날짜를 HTML에 표시
  document.getElementById('created-at').textContent = formatDate(createdAt);

</script>

{% endblock %}
