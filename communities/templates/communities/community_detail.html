{% extends 'base.html' %}

{% block title %}
ì»¤ë®¤ë‹ˆí‹° ê¸€ ìƒì„¸
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>{{ community.title }}</h2>
  <p>ì‘ì„±ì: {{ community.author }} | ì‘ì„±ì¼: <span id="created-at"></span>
    <button id="edit-btn" class="btn btn-warning" style="display: none;">ìˆ˜ì •</button>
    <button id="delete-btn" class="btn btn-danger" style="display: none;">ì‚­ì œ</button>
  </p>
  
  <div class="mt-4">
    <p>{{ community.content }}</p>
  </div>
  
  <!-- ì´ë¯¸ì§€ ëª©ë¡ -->
  <div class="mt-4">
    <div class="row">
      {% for image in community.community_images %}
      <div class="col-md-4 mb-3">
        <img src="{{ image.community_image }}" class="img-fluid" alt="community image">
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ì¢‹ì•„ìš” / ì‹«ì–´ìš” ë²„íŠ¼ -->
  <div class="mt-4">
    <button id="like-btn" class="btn btn-outline-success">ì¢‹ì•„ìš”</button>
    <button id="dislike-btn" class="btn btn-outline-danger">ì‹«ì–´ìš”</button>
    <span>ì¢‹ì•„ìš” ìˆ˜: {{ community.community_likes.count }} | ì‹«ì–´ìš” ìˆ˜: {{ community.community_dislikes.count }}</span>
  </div>

  <div class="mt-5">
    <h5>ëŒ“ê¸€</h5>
    <div id="comments-section">
      {% for comment in community.comments %}
      <div class="comment mb-4">
        <p><strong>{{ comment.user_nickname }} :</strong> {{ comment.content }}</p>
        <p><small id="created-at-{{ comment.id }}" data-created-at="{{ comment.created_at }}"></small></p>
        <!-- ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ -->
        <button class="btn btn-sm btn-outline-success like-comment-btn" data-comment-id="{{ comment.id }}">ğŸ‘<span>{{ comment.like_count }}</span></button>
        
        <button class="btn btn-sm btn-outline-danger dislike-comment-btn" data-comment-id="{{ comment.id }}">ğŸ‘<span>{{ comment.dislike_count }}</span></button>
        
      </div>
      {% endfor %}
    </div>
  
    <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
    <div class="mt-4">
      <h5>ëŒ“ê¸€ ì‘ì„±</h5>
      <form id="comment-form" method="POST">
        <div class="form-group">
          <textarea id="comment-content" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <button type="submit" class="btn btn-primary mt-3">ëŒ“ê¸€ ì‘ì„±</button>
      </form>
    </div>
  </div>
<script>

  document.addEventListener('DOMContentLoaded', function () {
    const accessToken = localStorage.getItem('access_token');

    if (accessToken) {
      fetch("/api/accounts/user-info/", {
        method: "GET",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„ê³¼ ì‘ì„±ìì˜ ë‹‰ë„¤ì„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        if (data.nickname === "{{ community.author }}") {
          // ì‘ì„±ìê°€ ì¼ì¹˜í•˜ë©´ ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ì„ í‘œì‹œ
          document.getElementById('edit-btn').style.display = 'inline-block';
          document.getElementById('delete-btn').style.display = 'inline-block';
        }
      })
      .catch(error => {
        console.error('ì—ëŸ¬ ë°œìƒ:', error);
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
      });
    }
});

  // ì¢‹ì•„ìš” ë²„íŠ¼ ë™ì‘
  document.getElementById('like-btn').addEventListener('click', function() {
    // ì¢‹ì•„ìš” ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
    alert("ì¢‹ì•„ìš” í´ë¦­ë¨");
  });

  // ì‹«ì–´ìš” ë²„íŠ¼ ë™ì‘
  document.getElementById('dislike-btn').addEventListener('click', function() {
    // ì‹«ì–´ìš” ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
    alert("ì‹«ì–´ìš” í´ë¦­ë¨");
  });

  // ëŒ“ê¸€ ì‘ì„± ì²˜ë¦¬
  document.getElementById('comment-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const commentContent = document.getElementById('comment-content').value;
    const communityId = "{{ community.id }}";
    const accessToken = localStorage.getItem('access_token');
    
    fetch(`/api/communities/${communityId}/comments/`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content: commentContent })
    })
    .then(response => response.json())
    .then(data => {
      alert('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload(); // ëŒ“ê¸€ ì‘ì„± í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    })
    .catch(error => {
      console.error('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
      alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
  });

  // ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ ì²˜ë¦¬
  document.querySelectorAll('.like-comment-btn').forEach(button => {
    button.addEventListener('click', function() {
      const commentId = button.getAttribute('data-comment-id');
      fetch(`/api/communities/comments/${commentId}/like/`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
        },
      })
      .then(response => response.json())
      .then(data => {
        alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì™„ë£Œ');
        location.reload(); // ì¢‹ì•„ìš” ì²˜ë¦¬ í›„ ìƒˆë¡œê³ ì¹¨
      });
    });
  });

  document.querySelectorAll('.dislike-comment-btn').forEach(button => {
    button.addEventListener('click', function() {
      const commentId = button.getAttribute('data-comment-id');
      fetch(`/api/communities/comments/${commentId}/dislike/`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
        },
      })
      .then(response => response.json())
      .then(data => {
        alert('ì‹«ì–´ìš” ì²˜ë¦¬ ì™„ë£Œ');
        location.reload(); // ì‹«ì–´ìš” ì²˜ë¦¬ í›„ ìƒˆë¡œê³ ì¹¨
      });
    });
  });

  document.getElementById('delete-btn').addEventListener('click', function() {
    if (confirm('ì •ë§ë¡œ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const accessToken = localStorage.getItem('access_token');
        fetch(`/api/communities/{{ community.id }}/`, {
            method: "DELETE",
            headers: {
                'Authorization': `Bearer ${accessToken}`,
            }
        })
        .then(response => {
            if (response.ok) {
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = "{% url 'communities:community_list' %}";
            } else {
                alert('ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }
});

document.getElementById('edit-btn').addEventListener('click', function() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
    }

    // Redirect to edit page
    window.location.href = `/api/communities/{{ community.id }}/edit/`;
});

  // ëŒ“ê¸€ì˜ created_atì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
  function formatDate(dateString) {
    const date = new Date(dateString);
    const year = String(date.getFullYear()).slice(2);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}.${month}.${day} ${hours}:${minutes}`;
  }

  // ëª¨ë“  ëŒ“ê¸€ì˜ ë‚ ì§œë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„
  document.querySelectorAll('[id^="created-at-"]').forEach(function(element) {
    const createdAt = element.getAttribute('data-created-at');
    element.textContent = formatDate(createdAt);
  });

  const createdAt = "{{ community.created_at }}"; 

  // ë³€í™˜ëœ ë‚ ì§œë¥¼ HTMLì— í‘œì‹œ
  document.getElementById('created-at').textContent = formatDate(createdAt);

</script>

{% endblock %}
