{% extends 'base.html' %}
{% block title %}
{% if is_edit %}저널 수정{% else %}저널 작성{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>{% if is_edit %}저널 수정{% else %}저널 글 작성{% endif %}</h2>
  <form id="journal-write-form" enctype="multipart/form-data" method="POST">
    <div class="mb-3">
      <label for="title" class="form-label">제목</label>
      <input type="text" class="form-control" id="title" name="title" value="{% if is_edit %}{{ journal.title }}{% endif %}" required>
    </div>
    <div class="mb-3">
      <label for="content" class="form-label">내용</label>
      <textarea class="form-control" id="content" name="content" rows="6" required>{% if is_edit %}{{ journal.content }}{% endif %}</textarea>
    </div>
    <div class="mb-3">
      <label for="images" class="form-label">이미지 업로드</label>
      <input type="file" class="form-control" id="images" name="images" multiple>
    </div>

    <button type="submit" class="btn btn-primary">{% if is_edit %}수정 완료{% else %}글 작성{% endif %}</button>
  </form>

  <script>
    function submitJournal() {
      const accessToken = localStorage.getItem('access_token');
      
      if (!accessToken) {
        alert("로그인 후 이용해주세요.");
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
      }
    
      const formData = new FormData();
      formData.append('title', document.getElementById('title').value);
      formData.append('content', document.getElementById('content').value);
    
      const imageFiles = document.getElementById('images').files;
      for (let i = 0; i < imageFiles.length; i++) {
        formData.append('images', imageFiles[i]);
      }
    
      let apiUrl = "/api/journals/write/";  // 기본 작성 URL
      let method = "POST";  // 기본 메서드는 POST로 설정
    
      {% if is_edit %}
      apiUrl = `/api/journals/{{ journal.id }}/edit/`;  // 수정일 경우 URL 변경
      method = "PUT";  // 수정일 경우 PUT 메서드로 설정
      {% endif %}
    
      fetch(apiUrl, {
        method: method,
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        },
        body: formData
      })
      .then(response => {
        console.log('서버 응답 상태 코드:', response.status);
        if (!response.ok) {
          if (response.status === 401) {
            return refreshAccessToken().then(newAccessToken => {
              return fetch(apiUrl, {
                method: method,
                headers: {
                  'Authorization': `Bearer ${newAccessToken}`,
                },
                body: formData
              });
            });
          }
          throw new Error(`저널 요청 실패: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        alert('저널이 성공적으로 {% if is_edit %}수정{% else %}작성{% endif %}되었습니다.');
        window.location.href = `/api/journals/${data.id}/`;
      })
      .catch(error => {
        console.error('에러 발생:', error);
        alert(`저널 작성 권한이 없습니다!`);
      });
    }

    function refreshAccessToken() {
      return fetch("/api/token/refresh/", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 'refresh': localStorage.getItem('refresh_token') })
      })
      .then(res => res.json())
      .then(data => {

        localStorage.setItem('access_token', data.access);
        return data.access;
      });
    }
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('journal-write-form').onsubmit = function(event) {
        event.preventDefault();
        submitJournal();
      };
    });
  </script>
</div>

{% endblock %}