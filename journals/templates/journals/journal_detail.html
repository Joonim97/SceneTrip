{% extends 'base.html' %}

{% block title %}
{{ journal.title }} - 상세 페이지
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>{{ journal.title }}</h2>
  <p>작성자: {{ journal.author_nickname }} &nbsp
    <!-- 구독 버튼 추가 -->
    <button style="color:#000; background-color:#FFE082; border: none;" id="subscribe-btn" class="btn btn-primary" onclick="toggleSubscribe('{{ journal.author_nickname }}')">
      구독하기 
    </button>
    <button id="edit-btn" class="btn btn-warning" style="display: none; color:#FFFFFF; background-color:#A5D6A7; border: none;">수정</button>
    <button id="delete-btn" class="btn btn-danger" style="display: none; background-color:#A5D6A7; border: none;">삭제</button>
  </p>
  <p>작성일: <span id="created-at"></span></p>

    <div class="mb-3">
    <h5>내용</h5>
    <p>{{ journal.content }}</p>
  </div>

  <div class="row">
    {% for image in journal.journal_images %}
      <div class="col-md-4">
        <img src="{{ image.journal_image }}" class="img-fluid">
      </div>
    {% endfor %}
  </div>


  <div class="mt-4">
    <!-- 좋아요 버튼 -->
    <button id="like-btn" class="btn btn-outline-success" style="background-color: #FFE082; border: none;">
      🤍 <!-- 기본 상태는 빈 하트 -->
    </button>
    <span>좋아요 수: {{ journal.likes_count }} | 댓글 수: {{ journal.comments_count }}</span>
  </div>

  <!-- 댓글 목록 -->
  <div class="mt-5">
    <h5>댓글</h5>
    {% if journal.comments %}
      {% for comment in journal.comments %}
        <div class="comment mb-3">
          <p><strong>{{ comment.user_nickname }} :</strong> {{ comment.content }}</p>
          <p><small id="created-at-{{ comment.id }}" data-created-at="{{ comment.created_at }}"></small></p>
  
          <!-- 댓글 좋아요/싫어요 버튼 및 카운트 -->
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-success like-btn" data-comment-id="{{ comment.id }}" data-like-type="like">
              👍 <span id="like-count-{{ comment.id }}">{{ comment.like_count }}</span>
            </button>
            <button class="btn btn-sm btn-outline-danger dislike-btn" data-comment-id="{{ comment.id }}" data-like-type="dislike">
              👎 <span id="dislike-count-{{ comment.id }}">{{ comment.dislike_count }}</span>
            </button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>댓글이 없습니다.</p>
    {% endif %}
  </div>

  

  <!-- 댓글 작성 -->
  <div class="mb-3">
    <h5>댓글 작성</h5>
    <form id="comment-form" method="POST">
      <textarea id="comment-content" class="form-control" rows="3" placeholder="댓글을 입력하세요"></textarea>
      <button type="submit" class="btn btn-primary mt-2">댓글 작성</button>
    </form>
  </div>
</div>
<script>

  document.addEventListener('DOMContentLoaded', function () {
    const accessToken = localStorage.getItem('access_token');

    if (accessToken) {
      fetch("/api/accounts/user-info/", {
        method: "GET",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        // 로그인한 사용자의 닉네임과 작성자의 닉네임이 일치하는지 확인
        if (data.nickname === "{{ journal.author_nickname }}") {
          // 작성자가 일치하면 수정, 삭제 버튼을 표시
          document.getElementById('edit-btn').style.display = 'inline-block';
          document.getElementById('delete-btn').style.display = 'inline-block';
        }
      })
      .catch(error => {
        console.error('에러 발생:', error);
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
      });
    }
});

  function toggleSubscribe(authorNickname) {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      alert("로그인 후 이용해주세요.");
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/accounts/${authorNickname}/subscribes/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
      location.reload();  // 구독 상태 변경 후 페이지 새로고침
    })
    .catch(error => {
      console.error("구독 처리 중 에러 발생:", error);
    });
  }

  // 댓글 좋아요/싫어요 처리
  document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
    button.addEventListener('click', function() {
      const commentId = button.getAttribute('data-comment-id');
      const likeType = button.getAttribute('data-like-type');
      const accessToken = localStorage.getItem('access_token');

      if (!accessToken) {
        alert('로그인 후 이용해주세요.');
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
      }

      fetch(`/api/journals/comments/${commentId}/${likeType}/`, {
        method: "POST",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        }
      })
      .then(response => response.json())
      .then(data => {
        // 좋아요/싫어요 카운트 업데이트
        document.getElementById(`like-count-${commentId}`).textContent = data.like_count;
        document.getElementById(`dislike-count-${commentId}`).textContent = data.dislike_count;

        // 메시지 알림
        alert(data.message);

        // 댓글이 삭제되었을 경우 페이지 새로고침
        if (data.message.includes('댓글이 삭제되었습니다')) {
          location.reload();
        }
      })
      .catch(error => {
        console.error('댓글 좋아요/싫어요 처리 중 에러:', error);
      });
    });
  });

  // 좋아요 상태 확인 함수
  function checkLikeStatus() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      return;  // 토큰이 없으면 좋아요 상태를 확인하지 않음
    }

    fetch(`/api/journals/{{ journal.journalKey }}/like-status/`, {
      method: "GET",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.is_liked) {
        document.getElementById('like-btn').innerHTML = '❤️';  // 꽉 찬 하트로 변경
      } else {
        document.getElementById('like-btn').innerHTML = '🤍';  // 빈 하트로 변경
      }
    })
    .catch(error => {
      console.error('좋아요 상태 확인 실패:', error);
    });
  }

  // 페이지 로드 시 좋아요 상태 확인
  document.addEventListener('DOMContentLoaded', checkLikeStatus);

  // 좋아요 버튼 클릭 시 처리
  document.getElementById('like-btn').addEventListener('click', function() {
    const accessToken = localStorage.getItem('access_token');

    if (!accessToken) {
      alert('로그인 후 이용해주세요.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/journals/{{ journal.journalKey }}/like/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.is_liked) {
        document.getElementById('like-btn').innerHTML = '❤️';  // 꽉 찬 하트로 변경
      } else {
        document.getElementById('like-btn').innerHTML = '🤍';  // 빈 하트로 변경
      }
    })
    .then(data => {
      alert('좋아요!');
      location.reload();  // 페이지 새로고침
    })
    .catch(error => {
      console.error('좋아요 처리 중 에러:', error);
    });
  });


  // 댓글 작성 처리
  document.getElementById('comment-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const commentContent = document.getElementById('comment-content').value;
    const accessToken = localStorage.getItem('access_token');

    if (!accessToken) {
      alert('로그인 후 이용해주세요.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/journals/{{ journal.journalKey }}/comments/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        content: commentContent
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('댓글 작성 실패');
      }
      return response.json();
    })
    .then(data => {
      alert('댓글이 성공적으로 작성되었습니다.');
      location.reload();  // 페이지 새로고침
    })
    .catch(error => {
      console.error('에러 발생:', error);
      alert('댓글 작성 중 문제가 발생했습니다.');
    });
  });

  document.getElementById('delete-btn').addEventListener('click', function() {
    if (confirm('정말로 이 글을 삭제하시겠습니까?')) {
      const accessToken = localStorage.getItem('access_token');
      fetch(`/api/journals/{{ journal.journalKey }}/`, {
        method: "DELETE",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        }
      })
      .then(response => {
        if (response.ok) {
          alert('삭제되었습니다.');
          window.location.href = "{% url 'journals:journal_list' %}";
        } else {
          alert('삭제 중 문제가 발생했습니다.');
        }
      });
    }
  });

  document.getElementById('edit-btn').addEventListener('click', function() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      alert('로그인 후 이용해주세요.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    // GET 요청을 보내 수정 페이지로 이동
    fetch(`/api/journals/`, {
      method: "GET",
      headers: {
        'Authorization': `Bearer ${accessToken}`,  // 토큰 포함
      }
    })
    .then(response => {
      if (response.ok) {
        // 요청이 성공하면 바로 수정 페이지로 이동 (fetch 사용 안함)
        window.location.href = `/api/journals/{{ journal.journalKey }}/edit/`;
      } else {
        throw new Error('수정 권한이 없습니다.');
      }
    })
    .catch(error => {
      console.error('수정 페이지 접근 에러:', error);
      alert('수정 페이지로 이동할 수 없습니다.');
    });
  });

  // 댓글의 created_at을 처리하는 함수
  function formatDate(dateString) {
    const date = new Date(dateString);
    const year = String(date.getFullYear()).slice(2);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}.${month}.${day} ${hours}:${minutes}`;
  }

  // 모든 댓글의 날짜를 처리하는 부분
  document.querySelectorAll('[id^="created-at-"]').forEach(function(element) {
    const createdAt = element.getAttribute('data-created-at');
    element.textContent = formatDate(createdAt);
  });

  const createdAt = "{{ journal.created_at }}"; 

  // 변환된 날짜를 HTML에 표시
  document.getElementById('created-at').textContent = formatDate(createdAt);
    
  
  </script>

{% endblock %}
