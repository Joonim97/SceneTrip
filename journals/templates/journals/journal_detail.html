{% extends 'base.html' %}

{% block title %}
{{ journal.title }} - ìƒì„¸ í˜ì´ì§€
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>{{ journal.title }}</h2>
  <p>ì‘ì„±ì: {{ journal.author_nickname }}
    <!-- êµ¬ë… ë²„íŠ¼ ì¶”ê°€ -->
    <button id="subscribe-btn" class="btn btn-primary" onclick="toggleSubscribe('{{ journal.author_nickname }}')">
      êµ¬ë…í•˜ê¸°
    </button>
    <button id="edit-btn" class="btn btn-warning">ìˆ˜ì •</button>
    <button id="delete-btn" class="btn btn-danger">ì‚­ì œ</button>
  </p>
  <p>ì‘ì„±ì¼: {{ journal.created_at }}</p>

  
  <div class="mb-3">
    <h5>ë‚´ìš©</h5>
    <p>{{ journal.content }}</p>
  </div>

  <div class="row">
    {% for image in journal.journal_images %}
      <div class="col-md-4">
        <img src="{{ image.journal_image }}" class="img-fluid">
      </div>
    {% endfor %}
  </div>



  <!-- ì¢‹ì•„ìš” ë° ëŒ“ê¸€ ìˆ˜ -->
  <div class="mb-3">
    <span>ì¢‹ì•„ìš” ìˆ˜: {{ journal.likes_count }}</span>
    <span>ëŒ“ê¸€ ìˆ˜: {{ journal.comments_count }}</span>
  </div>

  <div class="mt-4">
    <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
    <button id="like-btn" class="btn">
      ğŸ¤ <!-- ê¸°ë³¸ ìƒíƒœëŠ” ë¹ˆ í•˜íŠ¸ -->
    </button>
  </div>

  <!-- ëŒ“ê¸€ ëª©ë¡ -->
  <div class="mb-3">
    <h5>ëŒ“ê¸€</h5>
    {% if journal.comments %}
      {% for comment in journal.comments %}
        {% if not comment.parent %} <!-- ë¶€ëª¨ ëŒ“ê¸€ì´ ì—†ëŠ” ëŒ“ê¸€ë§Œ ì¶œë ¥ (ì›ëŒ“ê¸€) -->
        <div class="comment mb-3">
          <p><strong>{{ comment.user_nickname }}:</strong> {{ comment.content }}</p>
          <p><small>{{ comment.created_at }}</small></p>
  
          <!-- ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ ë° ì¹´ìš´íŠ¸ -->
          <div class="d-flex align-items-center">
            <button class="btn btn-link like-btn" data-comment-id="{{ comment.id }}" data-like-type="like">
              ğŸ‘ ì¢‹ì•„ìš” (<span id="like-count-{{ comment.id }}">{{ comment.like_count }}</span>)
            </button>
            <button class="btn btn-link dislike-btn" data-comment-id="{{ comment.id }}" data-like-type="dislike">
              ğŸ‘ ì‹«ì–´ìš” (<span id="dislike-count-{{ comment.id }}">{{ comment.dislike_count }}</span>)
            </button>
          </div>
  
          <!-- ëŒ€ëŒ“ê¸€ ì‘ì„± ë²„íŠ¼ -->
          <button class="btn btn-link reply-btn" data-comment-id="{{ comment.id }}">ëŒ€ëŒ“ê¸€ ì‘ì„±</button>
  
          <!-- ëŒ€ëŒ“ê¸€ ì‘ì„± í¼ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€ ìƒíƒœ) -->
          <form id="reply-form-{{ comment.id }}" class="reply-form" style="display: none;" method="POST">
            <textarea class="form-control" rows="2" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <button type="submit" class="btn btn-primary mt-2">ëŒ€ëŒ“ê¸€ ì‘ì„±</button>
          </form>
  
          <!-- ëŒ€ëŒ“ê¸€ ì¶œë ¥ -->
          <div class="replies ml-4">
            {% for reply in journal.comments %}
            {% if reply.parent.id == comment.id %} <!-- parent í•„ë“œê°€ ì›ëŒ“ê¸€ì˜ idì™€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ -->
            <div class="reply mb-2" style="border-left: 2px solid #ccc; padding-left: 10px;">
              <p><strong>{{ reply.user_nickname }}:</strong> {{ reply.content }}</p>
              <p><small>{{ reply.created_at }}</small></p>
            </div>
            {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  

  <!-- ëŒ“ê¸€ ì‘ì„± -->
  <div class="mb-3">
    <h5>ëŒ“ê¸€ ì‘ì„±</h5>
    <form id="comment-form" method="POST">
      <textarea id="comment-content" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <button type="submit" class="btn btn-primary mt-2">ëŒ“ê¸€ ì‘ì„±</button>
    </form>
  </div>
</div>

<script>
  function toggleSubscribe(authorNickname) {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/accounts/${authorNickname}/subscribes/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
      location.reload();  // êµ¬ë… ìƒíƒœ ë³€ê²½ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    })
    .catch(error => {
      console.error("êµ¬ë… ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
    });
  }

  // ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì²˜ë¦¬
  document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
    button.addEventListener('click', function() {
      const commentId = button.getAttribute('data-comment-id');
      const likeType = button.getAttribute('data-like-type');
      const accessToken = localStorage.getItem('access_token');

      if (!accessToken) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
      }

      fetch(`/api/journals/comments/${commentId}/${likeType}/`, {
        method: "POST",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        }
      })
      .then(response => response.json())
      .then(data => {
        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        document.getElementById(`like-count-${commentId}`).textContent = data.like_count;
        document.getElementById(`dislike-count-${commentId}`).textContent = data.dislike_count;

        // ë©”ì‹œì§€ ì•Œë¦¼
        alert(data.message);

        // ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆì„ ê²½ìš° í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        if (data.message.includes('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤')) {
          location.reload();
        }
      })
      .catch(error => {
        console.error('ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì²˜ë¦¬ ì¤‘ ì—ëŸ¬:', error);
      });
    });
  });

  // ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ í•¨ìˆ˜
  function checkLikeStatus() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      return;  // í† í°ì´ ì—†ìœ¼ë©´ ì¢‹ì•„ìš” ìƒíƒœë¥¼ í™•ì¸í•˜ì§€ ì•ŠìŒ
    }

    fetch(`/api/journals/{{ journal.id }}/like-status/`, {
      method: "GET",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.is_liked) {
        document.getElementById('like-btn').innerHTML = 'â¤ï¸';  // ê½‰ ì°¬ í•˜íŠ¸ë¡œ ë³€ê²½
      } else {
        document.getElementById('like-btn').innerHTML = 'ğŸ¤';  // ë¹ˆ í•˜íŠ¸ë¡œ ë³€ê²½
      }
    })
    .catch(error => {
      console.error('ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
    });
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
  document.addEventListener('DOMContentLoaded', checkLikeStatus);

  // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
  document.getElementById('like-btn').addEventListener('click', function() {
    const accessToken = localStorage.getItem('access_token');

    if (!accessToken) {
      alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/journals/{{ journal.id }}/like/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.is_liked) {
        document.getElementById('like-btn').innerHTML = 'â¤ï¸';  // ê½‰ ì°¬ í•˜íŠ¸ë¡œ ë³€ê²½
      } else {
        document.getElementById('like-btn').innerHTML = 'ğŸ¤';  // ë¹ˆ í•˜íŠ¸ë¡œ ë³€ê²½
      }
    })
    .then(data => {
      alert('ì¢‹ì•„ìš”!');
      location.reload();  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    })
    .catch(error => {
      console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì—ëŸ¬:', error);
    });
  });

  // ëŒ€ëŒ“ê¸€ í¼ í† ê¸€
  document.querySelectorAll('.reply-btn').forEach(button => {
    button.addEventListener('click', function() {
      const commentId = button.getAttribute('data-comment-id');
      const replyForm = document.getElementById(`reply-form-${commentId}`);
      replyForm.style.display = (replyForm.style.display === 'none') ? 'block' : 'none';
    });
  });

  // ëŒ€ëŒ“ê¸€ ì‘ì„± ì²˜ë¦¬
  document.querySelectorAll('.reply-form').forEach(form => {
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      const parentCommentId = form.id.split('-')[2];
      const replyContent = form.querySelector('textarea').value;
      const accessToken = localStorage.getItem('access_token');

      if (!accessToken) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
      }

      fetch(`/api/journals/{{ journal.id }}/comments/${parentCommentId}/`, {
        method: "POST",
        headers: {
          'Authorization': `Bearer ${accessToken}`,

        },
        body: JSON.stringify({
          content: replyContent
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('ëŒ€ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨');
        }
        return response.json();
      })
      .then(data => {
        alert('ëŒ€ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.reload();  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
      })
      .catch(error => {
        console.error('ì—ëŸ¬ ë°œìƒ:', error);
        alert('ëŒ€ëŒ“ê¸€ ì‘ì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    });
  });

  // ëŒ“ê¸€ ì‘ì„± ì²˜ë¦¬
  document.getElementById('comment-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const commentContent = document.getElementById('comment-content').value;
    const accessToken = localStorage.getItem('access_token');

    if (!accessToken) {
      alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/journals/{{ journal.id }}/comments/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        content: commentContent
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨');
      }
      return response.json();
    })
    .then(data => {
      alert('ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload();  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    })
    .catch(error => {
      console.error('ì—ëŸ¬ ë°œìƒ:', error);
      alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  });

  document.getElementById('delete-btn').addEventListener('click', function() {
    if (confirm('ì •ë§ë¡œ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      const accessToken = localStorage.getItem('access_token');
      fetch(`/api/journals/{{ journal.id }}/`, {
        method: "DELETE",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        }
      })
      .then(response => {
        if (response.ok) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.href = "{% url 'journals:journal_list' %}";
        } else {
          alert('ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }
  });

  document.getElementById('edit-btn').addEventListener('click', function() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    // GET ìš”ì²­ì„ ë³´ë‚´ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
    fetch(`/api/journals/`, {
      method: "GET",
      headers: {
        'Authorization': `Bearer ${accessToken}`,  // í† í° í¬í•¨
      }
    })
    .then(response => {
      if (response.ok) {
        // ìš”ì²­ì´ ì„±ê³µí•˜ë©´ ë°”ë¡œ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™ (fetch ì‚¬ìš© ì•ˆí•¨)
        window.location.href = `/api/journals/{{ journal.id }}/edit/`;
      } else {
        throw new Error('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
      }
    })
    .catch(error => {
      console.error('ìˆ˜ì • í˜ì´ì§€ ì ‘ê·¼ ì—ëŸ¬:', error);
      alert('ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    });
  });
  
  
</script>

{% endblock %}
