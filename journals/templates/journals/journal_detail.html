{% extends 'base.html' %}

{% block title %}
{{ journal.title }} - ìƒì„¸ í˜ì´ì§€
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>{{ journal.title }}</h2>
  <p>ì‘ì„±ì: {{ journal.author_nickname }} &nbsp
    <!-- êµ¬ë… ë²„íŠ¼ ì¶”ê°€ -->
    <button style="color:#000; background-color:#FFE082; border: none;" id="subscribe-btn" class="btn btn-primary" onclick="toggleSubscribe('{{ journal.author_nickname }}')">
      êµ¬ë…í•˜ê¸° 
    </button>
    <button id="edit-btn" class="btn btn-warning" style="display: none; color:#FFFFFF; background-color:#A5D6A7; border: none;">ìˆ˜ì •</button>
    <button id="delete-btn" class="btn btn-danger" style="display: none; background-color:#A5D6A7; border: none;">ì‚­ì œ</button>
  </p>
  <p>ì‘ì„±ì¼: <span id="created-at"></span></p>

    <div class="mb-3">
    <h5>ë‚´ìš©</h5>
    <p>{{ journal.content }}</p>
  </div>

  <div class="row">
    {% for image in journal.journal_images %}
      <div class="col-md-4">
        <img src="{{ image.journal_image }}" class="img-fluid">
      </div>
    {% endfor %}
  </div>


  <div class="mt-4">
    <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
    <button id="like-btn" class="btn btn-outline-success" style="background-color: #FFE082; border: none;">
      ğŸ¤ <!-- ê¸°ë³¸ ìƒíƒœëŠ” ë¹ˆ í•˜íŠ¸ -->
    </button>
    <span>ì¢‹ì•„ìš” ìˆ˜: {{ journal.likes_count }} | ëŒ“ê¸€ ìˆ˜: {{ journal.comments_count }}</span>
  </div>

  <!-- ëŒ“ê¸€ ëª©ë¡ -->
  <div class="mt-5">
    <h5>ëŒ“ê¸€</h5>
    {% if journal.comments %}
      {% for comment in journal.comments %}
        <div class="comment mb-3">
          <p><strong>{{ comment.user_nickname }} :</strong> {{ comment.content }}</p>
          <p><small id="created-at-{{ comment.id }}" data-created-at="{{ comment.created_at }}"></small></p>
  
          <!-- ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ ë° ì¹´ìš´íŠ¸ -->
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-success like-btn" data-comment-id="{{ comment.id }}" data-like-type="like">
              ğŸ‘ <span id="like-count-{{ comment.id }}">{{ comment.like_count }}</span>
            </button>
            <button class="btn btn-sm btn-outline-danger dislike-btn" data-comment-id="{{ comment.id }}" data-like-type="dislike">
              ğŸ‘ <span id="dislike-count-{{ comment.id }}">{{ comment.dislike_count }}</span>
            </button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  

  <!-- ëŒ“ê¸€ ì‘ì„± -->
  <div class="mb-3">
    <h5>ëŒ“ê¸€ ì‘ì„±</h5>
    <form id="comment-form" method="POST">
      <textarea id="comment-content" class="form-control" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <button type="submit" class="btn btn-primary mt-2">ëŒ“ê¸€ ì‘ì„±</button>
    </form>
  </div>
</div>
<script>

  document.addEventListener('DOMContentLoaded', function () {
    const accessToken = localStorage.getItem('access_token');

    if (accessToken) {
      fetch("/api/accounts/user-info/", {
        method: "GET",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ë‹‰ë„¤ì„ê³¼ ì‘ì„±ìì˜ ë‹‰ë„¤ì„ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        if (data.nickname === "{{ journal.author_nickname }}") {
          // ì‘ì„±ìê°€ ì¼ì¹˜í•˜ë©´ ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ì„ í‘œì‹œ
          document.getElementById('edit-btn').style.display = 'inline-block';
          document.getElementById('delete-btn').style.display = 'inline-block';
        }
      })
      .catch(error => {
        console.error('ì—ëŸ¬ ë°œìƒ:', error);
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
      });
    }
});

  function toggleSubscribe(authorNickname) {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/accounts/${authorNickname}/subscribes/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      alert(data.message);
      location.reload();  // êµ¬ë… ìƒíƒœ ë³€ê²½ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    })
    .catch(error => {
      console.error("êµ¬ë… ì²˜ë¦¬ ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
    });
  }

  // ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì²˜ë¦¬
  document.querySelectorAll('.like-btn, .dislike-btn').forEach(button => {
    button.addEventListener('click', function() {
      const commentId = button.getAttribute('data-comment-id');
      const likeType = button.getAttribute('data-like-type');
      const accessToken = localStorage.getItem('access_token');

      if (!accessToken) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
      }

      fetch(`/api/journals/comments/${commentId}/${likeType}/`, {
        method: "POST",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        }
      })
      .then(response => response.json())
      .then(data => {
        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        document.getElementById(`like-count-${commentId}`).textContent = data.like_count;
        document.getElementById(`dislike-count-${commentId}`).textContent = data.dislike_count;

        // ë©”ì‹œì§€ ì•Œë¦¼
        alert(data.message);

        // ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆì„ ê²½ìš° í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        if (data.message.includes('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤')) {
          location.reload();
        }
      })
      .catch(error => {
        console.error('ëŒ“ê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì²˜ë¦¬ ì¤‘ ì—ëŸ¬:', error);
      });
    });
  });

  // ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ í•¨ìˆ˜
  function checkLikeStatus() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      return;  // í† í°ì´ ì—†ìœ¼ë©´ ì¢‹ì•„ìš” ìƒíƒœë¥¼ í™•ì¸í•˜ì§€ ì•ŠìŒ
    }

    fetch(`/api/journals/{{ journal.journalKey }}/like-status/`, {
      method: "GET",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.is_liked) {
        document.getElementById('like-btn').innerHTML = 'â¤ï¸';  // ê½‰ ì°¬ í•˜íŠ¸ë¡œ ë³€ê²½
      } else {
        document.getElementById('like-btn').innerHTML = 'ğŸ¤';  // ë¹ˆ í•˜íŠ¸ë¡œ ë³€ê²½
      }
    })
    .catch(error => {
      console.error('ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
    });
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
  document.addEventListener('DOMContentLoaded', checkLikeStatus);

  // ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
  document.getElementById('like-btn').addEventListener('click', function() {
    const accessToken = localStorage.getItem('access_token');

    if (!accessToken) {
      alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/journals/{{ journal.journalKey }}/like/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.is_liked) {
        document.getElementById('like-btn').innerHTML = 'â¤ï¸';  // ê½‰ ì°¬ í•˜íŠ¸ë¡œ ë³€ê²½
      } else {
        document.getElementById('like-btn').innerHTML = 'ğŸ¤';  // ë¹ˆ í•˜íŠ¸ë¡œ ë³€ê²½
      }
    })
    .then(data => {
      alert('ì¢‹ì•„ìš”!');
      location.reload();  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    })
    .catch(error => {
      console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì—ëŸ¬:', error);
    });
  });


  // ëŒ“ê¸€ ì‘ì„± ì²˜ë¦¬
  document.getElementById('comment-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const commentContent = document.getElementById('comment-content').value;
    const accessToken = localStorage.getItem('access_token');

    if (!accessToken) {
      alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    fetch(`/api/journals/{{ journal.journalKey }}/comments/`, {
      method: "POST",
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        content: commentContent
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨');
      }
      return response.json();
    })
    .then(data => {
      alert('ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload();  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    })
    .catch(error => {
      console.error('ì—ëŸ¬ ë°œìƒ:', error);
      alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
  });

  document.getElementById('delete-btn').addEventListener('click', function() {
    if (confirm('ì •ë§ë¡œ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      const accessToken = localStorage.getItem('access_token');
      fetch(`/api/journals/{{ journal.journalKey }}/`, {
        method: "DELETE",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        }
      })
      .then(response => {
        if (response.ok) {
          alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.href = "{% url 'journals:journal_list' %}";
        } else {
          alert('ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }
  });

  document.getElementById('edit-btn').addEventListener('click', function() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
      alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.');
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }

    // GET ìš”ì²­ì„ ë³´ë‚´ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
    fetch(`/api/journals/`, {
      method: "GET",
      headers: {
        'Authorization': `Bearer ${accessToken}`,  // í† í° í¬í•¨
      }
    })
    .then(response => {
      if (response.ok) {
        // ìš”ì²­ì´ ì„±ê³µí•˜ë©´ ë°”ë¡œ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™ (fetch ì‚¬ìš© ì•ˆí•¨)
        window.location.href = `/api/journals/{{ journal.journalKey }}/edit/`;
      } else {
        throw new Error('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
      }
    })
    .catch(error => {
      console.error('ìˆ˜ì • í˜ì´ì§€ ì ‘ê·¼ ì—ëŸ¬:', error);
      alert('ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    });
  });

  // ëŒ“ê¸€ì˜ created_atì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
  function formatDate(dateString) {
    const date = new Date(dateString);
    const year = String(date.getFullYear()).slice(2);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}.${month}.${day} ${hours}:${minutes}`;
  }

  // ëª¨ë“  ëŒ“ê¸€ì˜ ë‚ ì§œë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„
  document.querySelectorAll('[id^="created-at-"]').forEach(function(element) {
    const createdAt = element.getAttribute('data-created-at');
    element.textContent = formatDate(createdAt);
  });

  const createdAt = "{{ journal.created_at }}"; 

  // ë³€í™˜ëœ ë‚ ì§œë¥¼ HTMLì— í‘œì‹œ
  document.getElementById('created-at').textContent = formatDate(createdAt);
    
  
  </script>

{% endblock %}
