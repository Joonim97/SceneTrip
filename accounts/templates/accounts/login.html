{% extends 'base.html' %}

{% block title %}
  로그인
{% endblock %}

{% block content %}
  <div class="container mt-5">
    <h2>로그인</h2>
    <form id="login-form" method="POST">
      <div class="mb-3">
        <label for="user_id" class="form-label">아이디</label>
        <input type="text" class="form-control" id="user_id" name="user_id" required />
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">비밀번호</label>
        <input type="password" class="form-control" id="password" name="password" required />
      </div>
      <button type="submit" class="btn btn-primary">로그인</button>
    </form>
    <a id="kakao-login-btn" href="javascript:loginWithKakao()"><img src="https://k.kakaocdn.net/14/dn/btroDszwNrM/I6efHub1SN5KCJqLm1Ovx1/o.jpg" width="222" alt="카카오 로그인 버튼" /></a>
    <p id="token-result"></p>
    <script>
      document.getElementById('login-form').addEventListener('submit', function (event) {
        event.preventDefault() // 기본 폼 제출 막기
      
        // 사용자 입력 값 가져오기
        const userId = document.getElementById('user_id').value
        const password = document.getElementById('password').value
      
        // 디버깅을 위해 입력값 콘솔에 출력
        console.log('User ID:', userId, 'Password:', password)
      
        // POST 요청을 보냄
        fetch("{% url 'accounts:token_obtain_pair' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: userId,
            password: password
          })
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error('네트워크 응답에 문제가 있습니다.')
            }
            return response.json()
          })
          .then((data) => {
            if (data.access) {
              // JWT 토큰을 로컬 스토리지에 저장
              localStorage.setItem('access_token', data.access)
              localStorage.setItem('refresh_token', data.refresh)
      
              // 메인 페이지로 리다이렉트
              window.location.href = "{% url 'index' %}"
            } else {
              alert('로그인 실패: ' + (data.detail || '아이디 또는 비밀번호를 확인하세요.'))
            }
          })
          .catch((error) => {
            console.error('로그인 요청 중 에러 발생:', error)
          })
      })
    </script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js" integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4" crossorigin="anonymous"></script>
    <script>
      Kakao.init('{{KAKAO_JAVA_SCRIPTS_API_KEY}}') // 사용하려는 앱의 JavaScript 키 입력
      
      function loginWithKakao() {
        Kakao.Auth.authorize({
          redirectUri: 'http://127.0.0.1:8000/api/accounts/social/callback/kakao/' // 자신의 URI로 수정
        })
      }
      
      // 로그인 후 access token을 서버로 전송하는 함수
      function sendAccessTokenToServer(token) {
        fetch('/api/accounts/store-token/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            access_token: token
          })
        })
          .then((response) => {
            if (response.ok) {
              // 성공적으로 토큰 저장 후 메인 페이지로 리다이렉트
              window.location.href = "{% url 'index' %}"
            } else {
              console.error('토큰 저장 실패')
            }
          })
          .catch((error) => {
            console.error('서버에 토큰 전송 중 에러 발생:', error)
          })
      }
      
      // 카카오톡 로그인 후 처리하는 함수
      Kakao.Auth.getAccessToken().then(function (token) {
        sendAccessTokenToServer(token)
      })
      // 아래는 데모를 위한 UI 코드입니다.
      displayToken()
      function displayToken() {
        var token = getCookie('authorize-access-token')
      
        if (token) {
          Kakao.Auth.setAccessToken(token)
          Kakao.Auth.getStatusInfo()
            .then(function (res) {
              if (res.status === 'connected') {
                document.getElementById('token-result').innerText = 'login success, token: ' + Kakao.Auth.getAccessToken()
              }
            })
            .catch(function (err) {
              Kakao.Auth.setAccessToken(null)
            })
        }
      }
      
      function getCookie(name) {
        var parts = document.cookie.split(name + '=')
        if (parts.length === 2) {
          return parts[1].split(';')[0]
        }
      }
    </script>
  </div>
{% endblock %}
