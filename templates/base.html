<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Scene Trip{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* ê²€ìƒ‰ë°”ì˜ placeholder í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
    input::placeholder {
      text-align: center; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
    }

    /* ê²€ìƒ‰ë°” ë‚´ë¶€ í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
    input {
      text-align: center; /* í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
      line-height: normal; /* í…ìŠ¤íŠ¸ ë†’ì´ ì¡°ì • */
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <!-- ì¢Œì¸¡ ìƒë‹¨ ë¸Œëœë“œ ë¡œê³  -->
      <a href="{% url 'index' %}" class="navbar-brand" >
        <img src="{% static 'SceneTrip.jpg' %}" alt="Brand Logo" height="60">
      </a>

      <!-- ê²€ìƒ‰ ë°”ë¥¼ ì¤‘ì•™ì— ë°°ì¹˜ -->
      <div class="d-flex justify-content-center" style="width: 80%;">
        <!-- ì €ë„ í˜ì´ì§€ë¡œ ì´ë™ -->
        <a href="{% url 'journals:journal_list' %}" class="btn btn-outline-primary me-2">Journal</a>
        <!-- ì»¤ë®¤ë‹ˆí‹° í˜ì´ì§€ë¡œ ì´ë™ -->
        <a href="{% url 'communities:community_list' %}" class="btn btn-outline-secondary me-2">Community</a>
        <!-- ì´¬ì˜ì§€ í˜ì´ì§€ë¡œ ì´ë™ -->
        <a href="{% url 'locations:location_list' %}" class="btn btn-outline-success">Location</a>
      </div>

      <!-- ìš°ì¸¡ ìƒë‹¨ ë¡œê·¸ì¸/íšŒì›ê°€ì… ë˜ëŠ” ë§ˆì´í˜ì´ì§€/ë¡œê·¸ì•„ì›ƒ -->
      <ul class="navbar-nav ms-auto" id="navbar-auth-links">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:signup' %}">íšŒì›ê°€ì…</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:login_page' %}">ë¡œê·¸ì¸</a>
        </li>
      </ul>
    </div>
  </nav>

  <head>
  <title>Button Placement</title>
    <style>
      #container a {
        position: absolute;
        top: 120px; 
        right: 30px; 
        display: flex;
        gap: 10px; 
        color: black;
        background-color: #F2F0EB;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
      }

      #container a:hover {
        background-color: #AAFA82;
        cursor: pointer;
      }

    </style>
</head>
      <div id="container">
        <a href="{% url 'locations:trip-planning' %}"><strong>ğŸ¤– AI ì—¬í–‰ í”Œë˜ë‹</strong></a>
      </div>
  
  <!-- í˜ì´ì§€ë³„ ë³¸ë¬¸ ì½˜í…ì¸  -->
  <div class="container mt-5">
    {% block content %} {% endblock %}
  </div>

  <script>
// ë¡œê·¸ì¸ ìš”ì²­ ì˜ˆì‹œ
function login() {
  fetch("/api/accounts/login/", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      username: "example",  // ì‚¬ìš©ì ì…ë ¥ ê°’ìœ¼ë¡œ ë³€ê²½
      password: "example"   // ì‚¬ìš©ì ì…ë ¥ ê°’ìœ¼ë¡œ ë³€ê²½
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.access) {
      // JWT í† í°ì„ localStorageì— ì €ì¥
      localStorage.setItem('access_token', data.access);
      localStorage.setItem('refresh_token', data.refresh);
      console.log("ë¡œê·¸ì¸ ì„±ê³µ. í† í° ì €ì¥ ì™„ë£Œ.");

      // UI ê°•ì œ ì—…ë°ì´íŠ¸ (ë§ˆì´í˜ì´ì§€ì™€ ë¡œê·¸ì•„ì›ƒ ë§í¬ í‘œì‹œ)
      fetchUserInfo();
    } else {
      console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", data);
    }
  })
  .catch(error => console.error('ë¡œê·¸ì¸ ìš”ì²­ ì—ëŸ¬:', error));
}

// ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ ë§ˆì´í˜ì´ì§€ì™€ ë¡œê·¸ì•„ì›ƒ ë§í¬ë¥¼ ì„¤ì •
function fetchUserInfo() {
  const accessToken = localStorage.getItem('access_token');
  const navbarAuthLinks = document.getElementById('navbar-auth-links');

  if (accessToken) {
    console.log('accessToken found:', accessToken);

    // 1. ë¨¼ì € ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜´
    fetch("/api/accounts/user-info/", {
      method: "GET",
      headers: {
        'Authorization': `Bearer ${accessToken}`,  // JWT ì•¡ì„¸ìŠ¤ í† í°ì„ í¬í•¨
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      return response.json();
    })
    .then(data => {
      console.log('ìœ ì € ì •ë³´:', data);
      // ë§ˆì´í˜ì´ì§€ì™€ ë¡œê·¸ì•„ì›ƒ ë§í¬ë¥¼ ì—…ë°ì´íŠ¸
      updateUserLinks(data);
    })
    .catch(error => {
      console.error('ì—ëŸ¬ ë°œìƒ:', error);
      navbarAuthLinks.innerHTML = `
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:signup' %}">íšŒì›ê°€ì…</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:login_page' %}">ë¡œê·¸ì¸</a>
        </li>
      `;
    });
  } else {
    console.log('accessToken ì—†ìŒ');
    navbarAuthLinks.innerHTML = `
      <li class="nav-item">
        <a class="nav-link" href="{% url 'accounts:signup' %}">íšŒì›ê°€ì…</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'accounts:login_page' %}">ë¡œê·¸ì¸</a>
      </li>
    `;
  }
}

// ë§ˆì´í˜ì´ì§€ì™€ ë¡œê·¸ì•„ì›ƒ ë§í¬ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
function updateUserLinks(data) {
  const accessToken = localStorage.getItem('access_token');
  const navbarAuthLinks = document.getElementById('navbar-auth-links');

  // ìœ ì € ë‹‰ë„¤ì„ì„ ë°˜ì˜í•œ ë§ˆì´í˜ì´ì§€ ë§í¬ ìƒì„±
  navbarAuthLinks.innerHTML = `
    <li class="nav-item">
      <a class="nav-link" id="mypage-link" href="#">ë§ˆì´í˜ì´ì§€</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" id="logout">ë¡œê·¸ì•„ì›ƒ</a>
    </li>
  `;

  // ë§ˆì´í˜ì´ì§€ í´ë¦­ ì‹œ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
  document.getElementById('mypage-link').addEventListener('click', function (event) {
    event.preventDefault();  // ê¸°ë³¸ ë§í¬ ë™ì‘ ë°©ì§€

    // ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” fetch ìš”ì²­
    fetch(`/api/accounts/${data.nickname}/mypage/`, {
      method: "GET",
      headers: {
        'Authorization': `Bearer ${accessToken}`,  // JWT í† í° í¬í•¨
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('ë§ˆì´í˜ì´ì§€ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      return response.text();  // ë§ˆì´í˜ì´ì§€ê°€ HTMLì´ë¼ë©´ .text()ë¡œ ì‘ë‹µ ë°›ê¸°
    })
    .then(html => {
      document.body.innerHTML = html;  // ë§ˆì´í˜ì´ì§€ HTMLì„ ë Œë”ë§
    })
    .catch(error => {
      console.error('ë§ˆì´í˜ì´ì§€ ìš”ì²­ ì—ëŸ¬ ë°œìƒ:', error);
    });
  });

  // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
  document.getElementById('logout').addEventListener('click', function () {
    localStorage.removeItem('access_token');
    localStorage.removeItem('refresh_token');
    window.location.href = "/";
  });
}

// DOMì´ ë¡œë“œë˜ë©´ ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ë§í¬ë¥¼ ì—…ë°ì´íŠ¸
document.addEventListener('DOMContentLoaded', fetchUserInfo);

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
