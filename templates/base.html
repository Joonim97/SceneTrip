{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Scene Trip{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }

    body {
      padding-top: 70px;
    }

    .navbar-nav-center {
      position: absolute;
      left: 50%;
      justify-content: center;
      transform: translateX(-50%);
      z-index: 1;
      flex-grow: 1;
    }
    
    /* 검색바의 placeholder 텍스트 중앙 정렬 */
    input::placeholder {
      text-align: center; /* 수평 중앙 정렬 */
    }

    /* 검색바 내부 텍스트 중앙 정렬 */
    input {
      text-align: center; /* 텍스트 중앙 정렬 */
      line-height: normal; /* 텍스트 높이 조정 */
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    h1, h2, h5 {
      font-weight: 600;
    }
    .btn-success {
      background-color: #ff5722;
      border: none;
      transition: background-color 0.3s ease;
    }
    .btn-success:hover {
      background-color: #e64a19;
    }
    .card {
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    img {
      object-fit: cover;
      border-radius: 8px;
    }
    .fade-in {
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    @keyframes fadeIn {
      100% {
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <!-- 좌측 상단 브랜드 로고 -->
      <a class="navbar-brand" href="{% url 'index' %}">
        <img src="{% static 'images/Logo_ST.png' %}" alt="Scene Trip Logo" height="40">
      </a>
  
      <div class="navbar-nav navbar-nav-center">
        <!-- 저널 페이지로 이동 -->
        <a href="{% url 'journals:journal_list' %}" class="btn btn-outline-secondary me-2">Journal</a>
        <!-- 커뮤니티 페이지로 이동 -->
        <a href="{% url 'communities:community_list' %}" class="btn btn-outline-secondary me-2">Community</a>
        <!-- 촬영지 페이지로 이동 -->
        <a href="{% url 'locations:location_list' %}" class="btn btn-outline-secondary me-2">Location</a>
        <!-- Q&A 페이지로 이동 -->
        <a href="{% url 'questions:qna-list' %}" class="btn btn-outline-secondary me-2">Question</a>
      </div>

      <!-- 우측 상단 로그인/회원가입 또는 마이페이지/로그아웃 -->
      <ul class="navbar-nav ms-auto" id="navbar-auth-links">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:signup' %}">회원가입</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'accounts:login_page' %}">로그인</a>
        </li>
      </ul>
  </nav>




    
  
  <!-- 페이지별 본문 콘텐츠 -->
  <div class="container mt-5">
    {% block content %} {% endblock %}
  </div>

  <script>
    function login() {
      fetch("/api/accounts/login/", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: "example",  // 사용자 입력 값으로 변경
          password: "example"   // 사용자 입력 값으로 변경
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.access) {
          // JWT 토큰을 localStorage에 저장
          localStorage.setItem('access_token', data.access);
          localStorage.setItem('refresh_token', data.refresh);
          console.log("로그인 성공. 토큰 저장 완료.");
    
          // UI 강제 업데이트 (마이페이지와 로그아웃 링크 표시)
          fetchUserInfo();
        } else {
          console.error("로그인 실패:", data);
        }
      })
      .catch(error => console.error('로그인 요청 에러:', error));
    }

    // URL에서 access_token과 refresh_token을 가져와서 로컬 스토리지에 저장
    const urlParams = new URLSearchParams(window.location.search);
    const accessTokenFromUrl = urlParams.get('access_token');
    const refreshTokenFromUrl = urlParams.get('refresh_token');

    if (accessTokenFromUrl) {
        localStorage.setItem('access_token', accessTokenFromUrl);
        console.log("Access Token 저장됨:", accessTokenFromUrl);
    }

    if (refreshTokenFromUrl) {
        localStorage.setItem('refresh_token', refreshTokenFromUrl);
        console.log("Refresh Token 저장됨:", refreshTokenFromUrl);
    }

    // 사용자 정보를 가져와 마이페이지와 로그아웃 링크를 설정
    function fetchUserInfo() {
      const accessToken = localStorage.getItem('access_token');
      console.log('Access Token:', accessToken);
      const navbarAuthLinks = document.getElementById('navbar-auth-links');

      if (accessToken) {
        console.log('accessToken found:', accessToken);

        // 1. 먼저 사용자 정보를 가져옴
        fetch("/api/accounts/user-info/", {
          method: "GET",
          headers: {
            'Authorization': `Bearer ${accessToken}`,  // JWT 액세스 토큰을 포함
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('사용자 정보를 가져올 수 없습니다.');
          }
          return response.json();
        })
        .then(data => {
          console.log('유저 정보:', data);
          // 마이페이지와 로그아웃 링크를 업데이트
          updateUserLinks(data);
        })
        .catch(error => {
          console.error('에러 발생:', error);
          navbarAuthLinks.innerHTML = `
            <li class="nav-item">
              <a class="nav-link" href="{% url 'accounts:signup' %}">회원가입</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'accounts:login_page' %}">로그인</a>
            </li>
          `;
        });
      } else {
        console.log('accessToken 없음');
        navbarAuthLinks.innerHTML = `
          <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:signup' %}">회원가입</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:login_page' %}">로그인</a>
          </li>
        `;
      }
    }

    // 마이페이지와 로그아웃 링크를 업데이트하는 함수
    function updateUserLinks(data) {
      const navbarAuthLinks = document.getElementById('navbar-auth-links');

      // 유저 닉네임을 반영한 마이페이지 링크 생성
      navbarAuthLinks.innerHTML = `
        <li class="nav-item">
          <a class="nav-link" onclick="mypage()" id="mypage-link" href="#"> ${data.nickname}님 마이페이지</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" onclick="logout()" href="#" id="logout">로그아웃</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/api/accounts/${data.nickname}/delete/" id="delete-account">회원탈퇴</a>
        </li>
      `;
    }

    function mypage() {
      const accessToken = localStorage.getItem('access_token');  // 저장된 토큰 가져오기

      if (accessToken) {
        fetch("/api/accounts/user-info/", {
          method: "GET",
          headers: {
            'Authorization': `Bearer ${accessToken}`,  // JWT 액세스 토큰 포함
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('사용자 정보를 가져올 수 없습니다.');
          }
          return response.json();
        })
        .then(data => {
          // 현재 로그인한 사용자의 마이페이지로 이동
          window.location.href = `/api/accounts/${data.nickname}/mypage/`;  // 마이페이지로 이동
        })
        .catch(error => {
          console.error('사용자 정보 요청 에러 발생:', error);
        });
      } 
    }

    function logout() {
      // 로그아웃 처리
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
      window.location.href = "/";
    }

    // DOM이 로드되면 사용자 정보를 확인하고 링크를 업데이트
    document.addEventListener('DOMContentLoaded', fetchUserInfo);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
