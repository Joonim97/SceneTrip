{% extends 'base.html' %}

{% block title %} 여행 플래닝 서비스 {% endblock %}

{% block content %}
<head>
  <title>Checkbox with Checkmark</title>
  <style>
    input[type="checkbox"] {
      width: 22px;
      height: 22px;
      cursor: pointer;
      vertical-align: bottom;
    }
    .pagination {       
      display: flex;       
      justify-content: center;       
      margin-top: 20px;     
    }     
    .pagination button {       
      margin: 0 5px;     
    }  
    .small-copy-btn {
        font-size: 15px; /* Font size */
        padding: 2px 5px; /* Padding */
        height: 25px; /* Optional: fixed height */
        text-decoration: none; /* Remove underline */
        display: inline-block; /* Ensures it behaves like a button */
        background-color: transparent; /* No background */
        border: 1px solid #BDBDBD; /* Optional: border color */
        color: #38610B; /* Text color */
        border-radius: 20px; /* Optional: rounded corners */
        cursor: pointer; /* Pointer cursor on hover */
        transition: background-color 0.3s, color 0.3s; /* Transition for hover effect */
    }
  </style>
</head>

<body>
  <h1>AI 여행 플래닝 서비스</h1><br><br>

  <div class="container mt-5">
    <div class="row">
      <!-- 여행 플래닝 서비스 폼 -->
      <div class="col-md-6">
        {% comment %} <h4>서비스 이용하기</h4> {% endcomment %}
        <form id="planning-form">
          <div class="form-group">
            <label for="place_name"><h5><strong>방문하고자 하는 촬영지</strong></h5></label><br>
            <small style="color:#0B610B">우측의 검색창을 이용해주세요. <br>검색 결과의 촬영지명과 동일한 촬영지명을 입력하셔야 적절한 여행계획이 생성됩니다. <br>복사버튼 이용을 추천드립니다.</small><br><br>
            <input type="text" class="form-control" id="place_name" placeholder="촬영지명을 정확히 입력해주세요" name="place_name" required>
          </div>
          <div class="form-group">
            <br><br><br>
            <label><h5><strong>얼마동안 여행을 다녀오실 건가요?</strong></h5></label><br><br>
            <input type="checkbox" id="day-checkbox" name="triptype" value="day">
            <label for="day-checkbox">당일치기로 다녀올래요!</label>
            <br><br>
            <input type="checkbox" id="days-checkbox" name="triptype" value="days">
            <label for="days-checkbox">하루는 너무 짧아요!</label>
          </div>
          <br>
          <div id="extra-info" style="display: none;">
            <label for="n">여행 기간 (박)</label>
            <input type="number" class="form-control" id="n" name="n" min="0" placeholder="숫자만 입력해주세요">
            <label for="m">여행 기간 (일)</label>
            <input type="number" class="form-control" id="m" name="m" min="1" placeholder="숫자만 입력해주세요">
          </div>
          <div class="form-group">
            <br><br>
            <label for="preference"><h5><strong>선호하는 여행 스타일을 입력해주세요.</strong></h5> (선택사항)</label>
            <br><br>
            <input type="text" class="form-control" id="preference" name="preference" maxlength="50" placeholder="50자 이내로 입력">
          </div>
          <br><br>
          <button type="submit" class="btn btn-primary" style="color:#FFFFFF solid #173B0B; background-color: #173B0B;">계획 세우기</button>
          <br><br>
        </form>
      </div>

      <!-- 촬영지 검색하기 -->
      <div class="col-md-4">
        <div class="container" style="border: 10px solid #FBF9E3; background-color: #FBF9E3; padding: 40px; border-radius: 25px;">
          <h4>촬영지 검색하기</h4>
          <br>
      <!-- 검색 바 추가 -->           
      <form id="searchForm" class="mb-4" onsubmit="event.preventDefault(); searchLocations();">             
        <div class="input-group">               
          <input type="text" class="form-control" id="searchInput" name="keyword" placeholder="촬영지 검색">               
          <div class="input-group-append">                 
            <button class="btn btn-primary" type="submit" style="color:#FFFFFF solid #173B0B; background-color: #173B0B;">검색</button>               
          </div>             
        </div>           
      </form>           
      <br><br>           
      <ul id="locationResults" class="list-group" style="height: 330px; overflow-y: auto;"></ul> 
      </div>       
    </div>     
    </div>   
  </div> 
</body>  

<script>   
  document.addEventListener('DOMContentLoaded', function (){
    const accessToken = localStorage.getItem('access_token');  
    if (!accessToken) {
      alert("로그인 후 이용해주세요.");
      window.location.href = "{% url 'accounts:login_page' %}";
      return;
    }
  })
  
  let currentPage = 1;
  const resultsPerPage = 5;
  let isLoading = false; 
  
  async function searchLocations(loadMore = false) {
      const searchValue = document.getElementById('searchInput').value;
  
      if (!loadMore) {
          currentPage = 1; 
          document.getElementById('locationResults').innerHTML = ''; 
      }
  
      if (isLoading) return; 
      isLoading = true;
  
      const response = await fetch(`/api/locations/search/?keyword=${encodeURIComponent(searchValue)}&page=${currentPage}&limit=${resultsPerPage}`);
      const data = await response.json();
  
      const resultsDiv = document.getElementById('locationResults');
  
      if (response.ok && data.length > 0) {
          data.forEach(location => {
              const locationItem = `
                  <li class="list-group-item">
                      <a href="/api/locations/${location.id}/" style="text-decoration: none; color: #4B8A08;">
                          ${location.place_name}
                      </a>
                      <span style="margin-left: 2px;">(${location.title})</span>
                      <a href="#" class="btn btn-secondary small-copy-btn" data-location="${location.place_name}" onclick="copyToClipboard('${location.place_name}'); return false;">복사</a>
                  </li>
              `;
              resultsDiv.innerHTML += locationItem;
          });
  
          currentPage++; 
      } else {
          if (!loadMore) {
              resultsDiv.innerHTML = '<li class="list-group-item">검색 결과가 없습니다.</li>';
          }
      }
      isLoading = false;
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert(`"${text}"이 클립보드에 복사되었습니다.`);
    }).catch(err => {
        console.error('클립보드 복사 실패:', err);
    });
}

  document.addEventListener('click', function(event) {
    if (event.target.classList.contains('copy-btn')) {
        const locationName = event.target.getAttribute('data-location');
        copyToClipboard(locationName);
    }
});

  // Detect scroll to the bottom of the results container

  const resultsDiv = document.getElementById('locationResults');
  resultsDiv.addEventListener('scroll', function() {
      if (resultsDiv.scrollTop + resultsDiv.clientHeight >= resultsDiv.scrollHeight) {
          searchLocations(true); // 검색 결과 끝까지 스크롤 가능하게 목록 로딩
      }
  });


      document.getElementById('days-checkbox').addEventListener('change', function() {
          const extraInfoDiv = document.getElementById('extra-info');
          if (this.checked) {
              extraInfoDiv.style.display = 'block'; // days에 체크됐을 때, input field 보여주기
          } else {
              extraInfoDiv.style.display = 'none';  // input field 가리기
          }
      });

      document.getElementById('day-checkbox').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('days-checkbox').checked = false; // 다른 체크박스 선택 취소
            document.getElementById('extra-info').style.display = 'none'; // 당일치기 여행 선택 시 여행기간 입력창 가리기
        }
    });

      document.getElementById('days-checkbox').addEventListener('change', function() {
          if (this.checked) {
              document.getElementById('day-checkbox').checked = false; // 다른 체크박스 선택 취소
              document.getElementById('extra-info').style.display = 'block'; // 여행기간 입력창 보이기
          } else {
              document.getElementById('extra-info').style.display = 'none';
          }
        });
      
      document.getElementById('planning-form').addEventListener('submit', async function(e) {
          e.preventDefault();            
          window.location.href = `/api/locations/plans/result`;

          const accessToken = localStorage.getItem('access_token');
          
          const place_name = document.getElementById('place_name').value;
          const n = document.getElementById('n').value || null;  // 기본값 설정
          const m = document.getElementById('m').value || 1;  // 기본값 설정
          const preference = document.getElementById('preference').value || "";  // 기본값 설정
          const responseContainer = document.getElementById('response-container');
          
          const url = new URL("/api/locations/plans/", window.location.origin);
          
          document.addEventListener('DOMContentLoaded', function (){
            
          if (!accessToken) {
            alert("로그인 후 이용해주세요.");
            window.location.href = "{% url 'accounts:login_page' %}";
            return;
          }
        })
          url.searchParams.append("place_name", place_name);
          url.searchParams.append("n", n);
          url.searchParams.append("m", m);
          url.searchParams.append("preference", preference);

          try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`, 
                },
                body: JSON.stringify({ place_name, n, m, preference })
            })


            .then(response => {response.json();})
            .then(data => {if (travel_plan) {
                responseContainer.innerHTML = `<h3>여행 계획</h3><p>${data.travel_plan}</p>`;
            } else if (response.status === 401) {
              responseContainer.innerHTML = '<h3>다시 로그인해주세요</h3>'
            } else {
                responseContainer.innerHTML = `<h3>오류 발생</h3><p>${data.message}</p>`;
            } 
          });        
          } catch (error) {
            responseContainer.innerHTML = '<h3>오류 발생</h3><p>서버와의 통신 중 오류가 발생했습니다.</p>'
          }
      });
  </script>

{% endblock %}
