{% extends 'base.html' %}

{% block title %}
저널 글 작성
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>저널 글 작성</h2>
  <form id="question-write-form" enctype="multipart/form-data" method="POST">
    <div class="mb-3">
      <label for="title" class="form-label">제목</label>
      <input type="text" class="form-control" id="title" name="title" required>
    </div>
    <div class="mb-3">
      <label for="content" class="form-label">내용</label>
      <textarea class="form-control" id="content" name="content" rows="6" required></textarea>
    </div>
    <div class="mb-3">
      <label for="images" class="form-label">이미지 업로드</label>
      <input type="file" class="form-control" id="images" name="images" multiple>
    </div>
    <button type="submit" class="btn btn-primary">글 작성</button>
  </form>

  <script>
    function submitQuestion() {
      const accessToken = localStorage.getItem('access_token');
      
      if (!accessToken) {
        alert("로그인 후 이용해주세요.");
        window.location.href = "{% url 'accounts:login_page' %}";
        return;
      }
    
      const formData = new FormData();
      formData.append('title', document.getElementById('title').value);
      formData.append('content', document.getElementById('content').value);
    
      const imageFiles = document.getElementById('images').files;
      for (let i = 0; i < imageFiles.length; i++) {
        formData.append('images', imageFiles[i]);
      }
    
      fetch("/api/questions/qna/page/write/", {
        method: "POST",
        headers: {
          'Authorization': `Bearer ${accessToken}`,
        },
        body: formData
      })
      .then(response => {
        console.log('서버 응답 상태 코드:', response.status);  // 상태 코드 출력
        if (!response.ok) {
          if (response.status === 401) {
            // 토큰 갱신이 필요한 경우
            return refreshAccessToken().then(newAccessToken => {
              return fetch("/api/questions/qna/page/write/", {
                method: "POST",
                headers: {
                  'Authorization': `Bearer ${newAccessToken}`,
                },
                body: formData
              });
            });
          }
          // 401 외의 에러 처리
          throw new Error(`저널 작성 실패: ${response.status}`);
        }
        // 응답을 JSON으로 변환
        return response.json();
      })
      .then(data => {
        alert('Q&A가 성공적으로 작성되었습니다.');
        window.location.href = `/api/questions/qna/page/`;
      })
      .catch(error => {
        console.error('에러 발생:', error);
        alert(`Q&A 작성 중 문제가 발생했습니다: ${error.message}`);
      });
      
    }
    

    // 토큰 갱신을 처리하는 함수
    function refreshAccessToken() {
      return fetch("/api/token/refresh/", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 'refresh': localStorage.getItem('refresh_token') })
      })
      .then(res => res.json())
      .then(data => {
        localStorage.setItem('access_token', data.access);  // 새 토큰 저장
        return data.access;  // 새 토큰 반환
      });
    }

    // 폼 제출 시 함수 호출
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('question-write-form').onsubmit = function(event) {
        event.preventDefault();
        submitQuestion();
      };
    });
  </script>
</div>
{% endblock %}